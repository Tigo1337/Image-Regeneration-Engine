/**
 * Constructs the sophisticated prompt for Gemini 3 Pro (Nano Banana Pro)
 * * @param {string} style - The selected design style (e.g., "Scandinavian")
 * @param {string} preservationString - Comma-separated items to keep (e.g., "The blue sofa, The ceiling beams")
 * @returns {string} The formatted system instruction prompt
 */
function constructDesignPrompt(style, preservationString) {
  // 1. Comprehensive Style Dictionary
  const styleDescriptions = {
    // Core Styles
    "Scandinavian": "white walls, light wood tones (ash/birch), functional furniture, minimal decor, soft textiles, abundant natural light, and hygge elements",
    "Modern": "clean lines, minimal clutter, neutral color palette (white/grey/black), glass and steel accents, geometric shapes, raw concrete",
    "Contemporary": "current trends, rounded curves, soft textures, sophisticated and fluid shapes, organic elements, mixed metals, sculptural lighting",
    "Boho": "rattan, macramÃ©, layered textiles, mismatched patterns, natural fibers (jute/wool), warm earth tones, abundant live plants, low-slung seating",
    "Industrial": "exposed brick, raw concrete floors, unfinished wood, black metal piping and fixtures, salvaged or utilitarian furniture, open-plan layout, visible ductwork",

    // Specialized & Trendy Styles
    "Mid-Century Modern": "teak and walnut woods, tapered legs, geometric fabrics, bright accent colors (orange/teal/yellow), low profile furniture, iconic 1950s/60s pieces",
    "Farmhouse": "shiplap walls, reclaimed wood, large comfortable seating, galvanized metal accents, oversized lighting fixtures, white cabinets, wide-plank floors",
    "Coastal": "light blue and white color palette, linen and cotton fabrics, nautical accents (rope/driftwood), rattan and wicker furniture, slipcovered sofas, large windows, airy feel",
    "Transitional": "seamless blend of traditional and contemporary elements, curved and straight lines, neutral color palette (taupe/beige), emphasis on texture, lack of excessive ornamentation",
    "Japandi": "light natural wood (bamboo/ash), minimalist decor, clean lines (Japanese), soft textures (Scandinavian), wabi-sabi appreciation of imperfections, low furniture profiles",
    "Maximalist": "bold colors and patterns, layered textures (velvet, silk), gallery walls with excessive art, ornate details, saturated jewel tones (emerald, sapphire)",
  };

  // Fallback if a style isn't found in the map
  const specificAesthetic = styleDescriptions[style] || styleDescriptions["Scandinavian"];

  // 2. Begin Prompt Construction
  let prompt = `You are an expert interior designer and architectural visualizer. `;

  // 3. CRITICAL: Perspective Lock (Ensures camera angle doesn't change)
  prompt += `\n\nCRITICAL INSTRUCTION - PERSPECTIVE LOCK:
  Maintain the exact camera angle, field of view, and vanishing points of the original input image. The structural geometry (walls, ceiling, floor lines) must be preserved unless altered by the style change.`;

  // 4. CRITICAL: Object Preservation Logic
  if (preservationString && preservationString.trim().length > 0) {
    prompt += `\n\nCRITICAL INSTRUCTION - OBJECT PRESERVATION:
    Strictly analyze the input image to identify the following elements: "${preservationString}".
    You must FREEZE the pixels associated with these specific elements. They must remain 100% UNCHANGED in geometry, texture, material, and position.
    Do not modify the structural shell of the room (walls, windows, ceiling) unless explicitly required by the style change.`;
  } else {
    // Fallback if user wants to change everything but keep the room structure
    prompt += `\n\nINSTRUCTION: Preserve the structural shell of the room (walls, floor, ceiling, windows) and perspective.`;
  }

  // 5. Transformation Logic (Applying the Style)
  prompt += `\n\nTRANSFORMATION GOAL:
  Redesign the rest of the room to match a "${style}" aesthetic.
  Key characteristics to apply: ${specificAesthetic}.
  Replace furniture, lighting, and decor that are NOT in the preservation list.`;

  // 6. Final Output & Composition (Centering Logic)
  prompt += `\n\nFINAL OUTPUT & COMPOSITION:
  Ensure lighting, shadows, and reflections blend realistically between the preserved elements and the new design.
  Generate a photorealistic result.`;

  // Only add centering instruction if there is a specific object to center
  if (preservationString && preservationString.trim().length > 0) {
     prompt += `\nIf the input image does not naturally center the MOST prominent item from "${preservationString}", slightly reframe the generated output to place that item centrally within the new aspect ratio, while strictly adhering to the original camera angle and perspective.`;
  }

  return prompt;
}

module.exports = { constructDesignPrompt };