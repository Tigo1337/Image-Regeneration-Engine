Task: Implement a new "Outpaint" feature that allows users to extend an image to a new aspect ratio without cropping the original content.

Step 1: Update server/image-utils.ts Add this helper function to calculate dimensions and create a padded canvas. This function takes an image, calculates the new size required for the target aspect ratio, and places the original image in the center of a grey canvas.

TypeScript
// Append to server/image-utils.ts

export async function prepareOutpaintCanvas(
  imageData: string,
  targetAspectRatio: string // "1:1", "16:9", "4:5", "9:16"
): Promise<string> {
  // Remove header if present
  const base64Data = imageData.replace(/^data:image\/\w+;base64,/, "");
  const buffer = Buffer.from(base64Data, "base64");
  
  const metadata = await sharp(buffer).metadata();
  const width = metadata.width!;
  const height = metadata.height!;
  const currentRatio = width / height;

  let targetRatioNum = 1;
  const [w, h] = targetAspectRatio.split(':').map(Number);
  if (w && h) targetRatioNum = w / h;

  let newWidth = width;
  let newHeight = height;

  // Calculate new dimensions to ENCLOSE the original image
  if (targetRatioNum > currentRatio) {
    // Target is wider (e.g. Portrait -> Landscape): Height stays same, Width increases
    newWidth = Math.round(height * targetRatioNum);
  } else {
    // Target is taller (e.g. Landscape -> Square): Width stays same, Height increases
    newHeight = Math.round(width / targetRatioNum);
  }

  // Calculate padding (centering the image)
  const padX = Math.max(0, Math.round((newWidth - width) / 2));
  const padY = Math.max(0, Math.round((newHeight - height) / 2));

  // Create the canvas with neutral grey background
  // The AI treats grey as "unrendered space" to be filled
  const canvas = await sharp(buffer)
    .extend({
      top: padY,
      bottom: padY,
      left: padX,
      right: padX,
      background: { r: 128, g: 128, b: 128, alpha: 1 } 
    })
    .toFormat("png")
    .toBuffer();

  return `data:image/png;base64,${canvas.toString('base64')}`;
}
Step 2: Create server/routes/outpaint.ts Create this new file to handle the API request. It uses a specialized system prompt to force the AI to only generate the missing borders.

TypeScript
import type { Express } from "express";
import { z } from "zod";
import { generateRoomRedesign } from "../gemini";
import { prepareOutpaintCanvas } from "../image-utils";
import { requireActiveSubscription, reportGenerationUsage, getUserId } from "../middleware/auth";
import { uploadImageToStorage } from "../image-storage";
import { storage } from "../storage";

const outpaintRequestSchema = z.object({
  imageData: z.string(),
  aspectRatio: z.string(), // "1:1", "16:9", etc.
  quality: z.string().default("High Fidelity (2K)"),
  outputFormat: z.string().default("PNG"),
});

export function registerOutpaintRoutes(app: Express) {
  app.post("/api/outpaint", requireActiveSubscription, async (req, res) => {
    try {
      const { imageData, aspectRatio, quality, outputFormat } = outpaintRequestSchema.parse(req.body);

      console.log(`[Outpaint] Extending image to ${aspectRatio}...`);

      // 1. Prepare the Canvas (Original centered + Grey Padding)
      const paddedImage = await prepareOutpaintCanvas(imageData, aspectRatio);

      // 2. Build the "Outpainting" Prompt
      const outpaintPrompt = `
        === ROLE: IMAGE EXTENDER ===
        You are an expert photo editor specializing in "Outpainting" and "Uncropping".
        
        === INPUT ===
        The provided image contains a central scene surrounded by GREY padding.
        
        === TASK ===
        Fill the GREY padding to extend the room seamlessly. 
        
        === STRICT CONSTRAINTS ===
        1. PRESERVE CENTER: The central part of the image (the original room) MUST REMAIN UNTOUCHED. Do not redesign the furniture or change the lighting of the existing center.
        2. SEAMLESS EXTENSION: The new content must match the perspective, vanishing points, flooring textures, and wall colors of the center.
        3. HALLUCINATE CONTEXT: If the ceiling is cut off, extend it naturally. If a window is cut off, complete it.
        4. NO ARTIFACTS: Do not leave any grey borders.
      `;

      // 3. Call Gemini
      // Creativity Level 2 allows it to invent the new surroundings naturally
      const generatedImage = await generateRoomRedesign({
        imageBase64: paddedImage,
        preservedElements: "the central original image",
        targetStyle: "Photorealistic",
        quality: quality,
        aspectRatio: aspectRatio, 
        creativityLevel: 2, 
        customPrompt: outpaintPrompt,
        outputFormat: outputFormat,
      });

      // 4. Save & Log
      const generatedImageUrl = await uploadImageToStorage(generatedImage, "generated");
      const originalImageUrl = await uploadImageToStorage(imageData, "originals");
      
      await storage.saveGeneratedDesign({
        userId: getUserId(req),
        timestamp: Date.now(),
        originalImageUrl,
        generatedImageUrl,
        originalFileName: "outpaint_extension",
        config: { 
            prompt: outpaintPrompt, 
            targetStyle: "Outpaint",
            aspectRatio 
        },
        variations: [],
      });

      // Log usage
      if (storage.createPromptLog) {
        await storage.createPromptLog({
          jobType: "outpaint",
          prompt: outpaintPrompt,
          parameters: { aspectRatio, mode: "Outpaint", quality }
        });
      }

      await reportGenerationUsage(req, quality);

      res.json({
        success: true,
        generatedImage,
        generatedImageUrl
      });

    } catch (error) {
      console.error("Error in /api/outpaint:", error);
      res.status(500).json({ 
        success: false, 
        error: error instanceof Error ? error.message : "Failed to outpaint image" 
      });
    }
  });
}
Step 3: Register the Route in server/routes.ts

Import the new router: import { registerOutpaintRoutes } from "./routes/outpaint";

Call the function inside registerRoutes: registerOutpaintRoutes(app);